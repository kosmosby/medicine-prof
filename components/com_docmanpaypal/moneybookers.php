<?php$jc = new JConfig();$mosConfig_db = $jc->db;$mosConfig_dbprefix = $jc->dbprefix;$mosConfig_host = $jc->host;$mosConfig_password = $jc->password;$mosConfig_user = $jc->user;$link = mysql_connect($mosConfig_host,$mosConfig_user,$mosConfig_password);mysql_select_db($mosConfig_db,$link);$dm = new docmanpaypal();if (!$dm->constructRun) {	$dm->__construct();}$doc_id = (int)JRequest::getVar('id');if ($dm->hasLicense == false) {	$product_price = 0.10;}if ($task == 'submit_order') {$seller_id = mysql_result(mysql_query("select user_id from $mosConfig_dbprefix" . "docmanpaypal where `id` = " . JRequest::getVar('id')),0);if (is_numeric(JRequest::getVar('id')) and JRequest::getVar('id') > 0) {	$product_price = mysql_result(mysql_query("select price from $mosConfig_dbprefix" . "docmanpaypal where `id` = " . JRequest::getVar('id')),0);	$product_name = mysql_result(mysql_query("select dmname from $mosConfig_dbprefix" . "docman where `id` = " . JRequest::getVar('id')),0);} else {	die("<h1>Failure.</h1>");}if ($dm->cfg['useVat'] > 0) {	$vat =  $dm->vatCalc($product_price);}?><form action="https://www.moneybookers.com/app/payment.pl" method="post" name="dmp_order_form"><input type="hidden" name="pay_to_email" value="<?=$dm->cfg['moneybookers_email'];?>"><input type="hidden" name="custom" value="<?php echo base64_encode(serialize(array('my_id' => $my->id,'doc_id' => (int)JRequest::getVar('id'),'seller_id' => $seller_id, 'order_id' => $order_id, 'key' => $key))); ?>"><input type="hidden" name="return_url" value="<?php echo $dm->cfg['live_site'] . "index.php?option=com_docmanpaypal&task=doc_download&gid=" . (int)JRequest::getVar('id') . "&key=$key&order_id=$order_id"; ?>"><input type="hidden" name="cancel_url" value="<?php echo $dm->cfg['live_site'] . "index.php?option=com_docmanpaypal&task=order_canceled"; ?>"><input type="hidden" name="status_url" value="<?php echo $dm->cfg['live_site'] . "index.php?option=com_docmanpaypal&task=ipn&merchant=Moneybookers";?>"><input type="hidden" name="language" value="EN"><input type="hidden" name="merchant_fields" value="custom"><input type="hidden" name="amount" value="<?php echo $product_price + $vat; ?>"><input type="hidden" name="currency" value="<?=$dm->cfg['moneybookers_currency'];?>"><input type="hidden" name="detail1_description" value="Product Name:"><input type="hidden" name="detail1_text" value="<?=$product_name;?>"><?php if ($vat > 0) {?><input type="hidden" name="detail2_description" value="<?php echo _DMP_TAX; ?>"><input type="hidden" name="detail2_text" value="<?php echo number_format($vat,2) . ' ' . $dm->cfg['moneybookers_currency']; ?>"><?php	}?><input type="hidden" name="confirmation_note" value="Thank you for your purchase!"><?phpecho $dm->cfg['moneybookers_processing_page'];//echo "<input type=\"submit\" value=\"Click Here\"></center>\n";?></form><?php}if ($task == 'ipn') {	$result = mysql_query("select * from $mosConfig_dbprefix" . "docmanpaypalconfig");	while ($row = mysql_fetch_assoc($result)) {		$$row['name'] = $row['value'];	}	foreach ($_REQUEST as $key => $val) {		$$key = $val;		$mailbody .= "$key = $val\n";	}	$tmp = unserialize(base64_decode($custom));    $my_id = (int)$tmp['my_id'];    $doc_id = (int)$tmp['doc_id'];    $seller_id = (int)$tmp['seller_id'];    $order_id = (int)$tmp['order_id'];    $key = $tmp['key'];    $dm->completeOrder($order_id);    $dm->updateOrder($order_id,array(    'price' => $amount,    'mc_currency' => $currency,    'transaction' => $transaction_id,    'email' => $pay_from_email,    'merchant' => 'Moneybookers'    ));            		 $conf =& JFactory::getConfig();			 $mail = JFactory::getMailer();	         //$mail->IsHTML(true);	         $mail->to = array();		         $mail->setBody($mailbody);	         $mail->setSubject('DOCman PayPal IPN (Pay Per Download) - Moneybookers Order Received!');	         if ($conf->getValue('config.mailer') == 'smtp') {	         	$mail->useSMTP($conf->getValue('config.smtpauth'),$conf->getValue('config.smtphost'),$conf->getValue('config.smtpuser'),$conf->getValue('config.smtppass'),$conf->getValue('config.smtpsecure'),$conf->getValue('config.smtpport'));	         }	         $mail->setSender($conf->getValue('config.mailfrom'));	         $mail->addRecipient($moneybookers_notifyemail);	         $mail->Send();		if ($dm->cfg['emailDelivery'] == 1) {		$dm->doEmailDelivery($pay_from_email,$doc_id,$order_id,$key);	}}?>